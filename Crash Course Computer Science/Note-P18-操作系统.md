# P18 操作系统 - Operating Systems

在计算机发展早期，1940-1950年代，计算机同时只能处理一个程序，读取打孔纸卡的程序进行计算，全程手动控制。随着计算机运行速度的提高，手动输入并启动程序的操作变得效率低下，因此产生了令计算机自行运行程序的需求，也即对操作系统的需求。

## 操作系统

操作系统(Operating Systems，OS)本身也是程序，但有着操作硬件的特殊权限，可以运行和管理其他程序，在计算机开机时，操作系统首先自启动，其他程序则是由操作系统启动。

### 批处理

第一个操作系统诞生于1950年代，来适配计算机能力的提高，OS首先加强了加载能力，此前只能每次输入一个程序，运行后停机，需要手动开始下一个程序。OS则赋予计算机“批处理”(Batch Processing)的能力，运行一段程序后，可以自动运行下一个，

### 抽象硬件

随着计算机的普及，原本的针对每台计算机外部设备(Peripherals)，如：处理器、读卡器、打印机等硬件，分别编写控制程序的方法，不再适用，程序员不能兼顾一个软件在所有电脑上跟不同硬件进行适配。

为了能够更高效地解决上述问题，使用操作系统来充当软件和硬件之间的媒介，提供API，也即设备驱动程序(Device Drivers)来抽象硬件。基于此，程序员可以使用标准化机制，和输入输出硬件(Input/Output, I/O)来交互，

### 多任务处理

在1950年代末，计算机速度已经非常快，处理器经常闲置，等待较慢的机械设备，如打印机等。此时，英国曼彻斯特大学，开始研发世界第一台超级计算机，Atlas，为了解决处理器闲置问题，充分利用算力，他们的解决方案是，一个名为Atlas Supervisor的程序，于1962年完成，除了有批处理能力，还通过调度(Scheduling)来实现了单个CPU上同时运行几个程序的能力，通过合理地将运行的程序进行休眠和切换启动，基于计算机“多任务处理”(Multitasking)的能力。

### 虚拟内存

由于程序运行中，总会占据一定空间的内存，当进行休眠切换时，这些内存数据是不能丢失的，其解决方法是为每个程序都分配专属的内存区，但是由于程序运行中所需的内存是变化的，可能导致在某个程序所分配的内存地址并非是连续的，这会导致程序员难以跟踪数据地址。

![addresses allocation](https://cdn.jsdelivr.net/gh/huchangjun-sjtu/picbed/image/20240130210438.png)

为了解决上述问题，计算机采用了“虚拟内存”(Virtual Memory)的方法，程序可以假定内存地址总是从0开始，而其实际的物理地址，则由操作系统进行抽象和隐藏，处理程序和物理内存的地址映射。

![Virtual Memory](https://cdn.jsdelivr.net/gh/huchangjun-sjtu/picbed/image/20240130210856.png)

这种方法使得程序的内存大小可以灵活的增减，实现了“动态内存分配”(Dynamic Memory Allocation)。这种方式也有效地将不同程序的内存进行隔离，避免某程序出错时搞乱其他内存，实现“内存保护”(Memory Protection)。

## 多用户分时操作系统

到1970年代，电脑足够便宜，大学会购买电脑给同学使用，这时 ，计算机不仅能同时运行多个程序，还能够让多个用户同时访问。同学使用的是“终端”(Terminal)连接到主计算机，终端本身不具备处理能力。为了避免某用户占用所有的计算和内存资源，开发了“分时操作系统”(Time-Sharing)，使得每个用户只能使用一部分处理器和内存资源。

早期最具影响力的分时操作系统是Multics(Multiplexed Information and Computing Service)，发布于1969年，是第一个在设计时就考虑到安全的操作系统，限制了用户的权限。这种复杂的设计使得这一操作系统占据了很多内存，大约1MB，基本是当时处理器的一半资源，一定程度上影响了其商业推广。

## Unix

Multics的两位研究员Dennis Ritchie和Ken Thompson针对上述问题，联手开发了新的操作系统Unix。该系统主要分为两个部分：

* 内核(Kernel)：负责操作系统的核心功能，如内存管理，多任务和输入输出处理；
* 有用的工具，如部分程序和库。

紧凑的内核结构，使得其缩减了许多功能，如抛弃了部分错误恢复功能，在遇到一些错误时，直接“内核恐慌”(kernel panic)，调用一个panic函数，(PS:初期是不断循环打印"panic")，阻止不正确的错误运行，以避免内核崩溃。

简单的系统设计使得其可以在更便宜的计算机运行，1971年发布后，就收到了广泛的欢迎和使用，并有人写了适配的程序编译和文本处理器，使得其成为1970-1980年代，最受欢迎的系统之一。

## MS-DOS

在1980年代初，计算机的价格降低到可以由个人和家庭使用，由于功能简单，因而操作系统也很简单，初期微软的磁盘操作系统(MS-DOS)只有160KB，一张磁盘就可以容纳。在1981年发布后，成为早期家用电脑最受欢迎的操作系统。由于缺乏“多任务处理”和“内存保护”，经常会系统崩溃，但仍然被广泛接受。在1985年，微软的早期windows系统仍缺少“内存保护”，程序行为不当时，会导致系统崩溃，出现蓝屏。
